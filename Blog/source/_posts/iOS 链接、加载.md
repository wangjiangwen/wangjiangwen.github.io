







## 问题

### 1. 静态链接&动态链接

静态链接是在形成可执行程序前，而动态链接的进行则是在程序执行时。

静态链接的优缺点很明显，缺点是一是浪费空间，二是更新困难；优点是在可执行文件程序中已经具备了所有执行程序所需要的任何东西，在执行速度更快。

动态链接的优缺点和静态链接正相反：优点是节省空间，更新方便；缺点是因为把链接推迟到了程序运行时，所以每次程序都需要进行链接



动态链接地址是如何重定位的呢？

前面我们讲过静态链接时地址的重定位，那我们现在就在想动态链接的地址又是如何重定位的呢？虽然动态链接把链接过程推迟到了程序运行时，但是在形成可执行文件时（注意形成可执行文件和执行程序是两个概念），还是需要用到动态链接库。比如我们在形成可执行程序时，发现引用了一个外部的函数，此时会检查动态链接库，发现这个函数名是一个动态链接符号，此时可执行程序就不对这个符号进行重定位，而把这个过程留到装载时再进行。

### 2. Mach-O

包含Header、Load Command、Data

Header：描述了文件的大概信息（文件类型、架构类型）

Load Command：由多条Load Command组成，它们描述了Data在二进制和虚拟内存中的布局信息，有了这个布局信息就能够知道Data在二进制文件中和虚拟内存是怎样排布的，它相当于修房子的图纸。

Data 存储了实际的内容，主要是程序的指令和数据，他们的排布完全依照 Load Commands的描述。

​     Data部分主要是以Segment（段）和Section（节）的方式来组织内容的，好比学校中的年级和班级、公司中有部门和小组一样。

​    Data部分中有5个Segment，依次是

          *  \_\_PAGEZERO
          *  \_\_TEXT
          *  \_\_DATA_CONST
          *  \_\_DATA
          *  \_\_LINKEDIT

 除 \_\_PAGEZERO和\_\_LINKEDIT外，每个段中有多个Section.

```
注意： Data与__Data是不同的两个概念。Data是Mach-O文件中的一部分，包含多个段。__DATA只是Data的一个段。
```

\_\_PAGEZERO的大小是4GB，但并不是它在Mach-O文件中的真实大小。这4GB是Mach-O加载进内容后，\_\_PAGEZERO在内存中占中的大小，它不可读，不可写，主要用来捕捉NULL指针的引用。如果访问\_\_PAGEZERO段，会引起 EXC_BAD_ACCESS错误。\_\_PAGEZERO在Mach-O中实际上并不占用Data部分的空间。

\_\_TEXT、\_\_DATA_CONST、\_\_DATA用于保存程序的代码指令和数据。

\_\_LINKEDIT包含启动App需要的信息，比如bind & rebase的地址，代码签名，符号表等。